name: Test Microservices

on:
  push:
#    branches:
#      - main
    tags:
      - 'v*.*.*'
env:
  #  å®¹å™¨æ³¨å†Œè¡¨
  REGISTRY: ccr.ccs.tencentyun.com
  HELM_REGISTRY: registry-1.docker.io
  HELM_REGISTRY_USER: lookeke
  # ç”¨æˆ·æˆ–ç»„ç»‡çš„æ³¨å†Œè¡¨å
  REGISTER_USER: sumery
  NAMESPACE: connect-example
  # ç‰ˆæœ¬å·, git tagçš„æ ‡ç­¾å
  # https://docs.github.com/zh/actions/writing-workflows/choosing-what-your-workflow-does/accessing-contextual-information-about-workflow-runs#github-context
  VERSION: ${{ github.ref_name }}
#  VERSION: v1.0.5
  # ç›®æ ‡çš„æ“ä½œç³»ç»Ÿ
  GOOS: linux
  # ç›®æ ‡çš„æ¶æ„
  GOARCH: arm64
  # golangçš„é•œåƒ
  GO_IMAGE: golang:1.25.1-alpine3.22
  # ä»£ç†
  GO_PROXY: https://proxy.golang.org
  # golangç¯å¢ƒå˜é‡
  CGO_ENABLED: 0

jobs:
  backend-test:
    runs-on: ubuntu-24.04-arm
    #    strategy:
    #      matrix:
    #        #        service: [address, cart, checkout, credit_card, order, payment, product, user]  # å¹¶è¡Œæ‰§è¡Œå¤šä¸ªæœåŠ¡
    #        service: [backend]  # å¹¶è¡Œæ‰§è¡Œå¤šä¸ªæœåŠ¡
    defaults:
      run:
        shell: bash
        #working-directory: ${{ matrix.service }}
        working-directory: backend
    #    services:
    #      postgres:
    #        image: postgres:17-alpine
    #        env:
    #          POSTGRES_USER: postgres
    #          POSTGRES_PASSWORD: postgres
    #          POSTGRES_DB: postgres
    #        options: >-
    #          --health-cmd pg_isready
    #          --health-interval 10s
    #          --health-timeout 5s
    #          --health-retries 5
    #        ports:
    #          - '5432:5432'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.1'
          check-latest: true
          cache-dependency-path: '**/go.sum'

      #      - name: Install migrate
      #        run: |
      #          curl -L https://github.com/golang-migrate/migrate/releases/download/v4.18.1/migrate.linux-amd64.tar.gz | tar xvz
      #          sudo mv migrate /usr/bin/
      #          which migrate
      #
      #      - name: Run database migration
      #        run: |
      #          export DB_SOURCE="postgresql://postgres:postgres@localhost:5432/postgres?sslmode=disable"
      #          if [ -d ${{ matrix.service }} ]; then
      #            echo "Running migrations..."
      #            make migrate-up
      #          else
      #            echo "Skipping migrations."
      #          fi

      - name: Run Go tests
        run: |
          go test -short -coverprofile=coverage.out ./...
          go tool cover -html=coverage.out -o coverage.html

  backend-build:
    if: github.ref != 'refs/heads/pre'  # å¦‚æœä¸æ˜¯ pre åˆ†æ”¯ï¼Œåˆ™è¿è¡Œ build ä»»åŠ¡
    needs: backend-test
    permissions:
      # Give the default GITHUB_TOKEN write permission to commit and push the
      # added or changed files to the repository.
      contents: write
      pull-requests: write
    runs-on: ubuntu-24.04-arm
    strategy:
      matrix:
        service_config:
          - { service: connect-example-backend}
    defaults:
      run:
        shell: bash
        working-directory: backend
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.repository.default_branch }}

      - name: Set up QEMU for cross-platform builds
        uses: docker/setup-qemu-action@v3

      - name: Cache Go dependencies
        uses: actions/cache@v3
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-modules-${{ hashFiles('**/go.sum') }}
          restore-keys: ${{ runner.os }}-go-modules-

      - name: Login to Docker Registry
        run: echo ${{ secrets.REGISTRY_PASSWORD }} | docker login ${{ env.REGISTRY }} --username ${{ secrets.REGISTRY_USERNAME }} --password-stdin

      - name: Build, Tag, and Push Docker Image
        run: |
          docker build . \
            -t actions/${{ matrix.service_config.service }} \
            --build-arg GO_PROXY=$GO_PROXY \
            --build-arg GOIMAGE=$GO_IMAGE \
            --build-arg CGOENABLED=$CGO_ENABLED \
            --build-arg VERSION=${{ env.VERSION }} \
            --build-arg GOOS=$GOOS \
            --build-arg GOARCH=$GOARCH \
            --build-arg SERVICE=server 

          docker tag actions/${{ matrix.service_config.service }} ${{ env.REGISTRY }}/${{ env.REGISTER_USER }}/${{ matrix.service_config.service }}:$VERSION
          docker push ${{ env.REGISTRY }}/${REGISTER_USER}/${{ matrix.service_config.service }}:$VERSION

      # 4. æ›´æ–° Helm Chart çš„ Image Tag
      - name: Update Helm Chart values.yaml
        run: |
          # å°†æ–°çš„é•œåƒ tag å†™å…¥ Chart çš„ values.yaml æ–‡ä»¶
          yq e '.backend.image.tag = "${{ github.sha }}"' -i helm/values.yaml

      # 5. (å¯é€‰ä½†æ¨è) æ›´æ–° Chart ç‰ˆæœ¬å¹¶æ‰“åŒ…
      - name: Bump Chart Version and Package
        run: |
          helm dependency update helm/charts/backend/
          helm package helm/charts/backend/ -d chart-packages/
          echo "${{ secrets.HELM_REGISTRY_PASS }}" | helm registry login registry-1.docker.io -u ${{ env.HELM_REGISTRY_USER }} --password-stdin
          helm push chart-packages/* oci://registry-1.docker.io/${{ env.HELM_REGISTRY_USER }}

      # 4. (ç»§ç»­) æ›´æ–° Helm Chart values.yaml
      - name: Update Helm Chart values.yaml
        run: |
          yq e '.backend.image.tag = "${{ github.sha }}"' -i helm/values.yaml
          # ğŸš¨ ç¡®ä¿ä½ æ‰€æœ‰çš„æœ¬åœ°ä¿®æ”¹ (åŒ…æ‹¬ yq å’Œ helm package) éƒ½å®Œæˆäº†

      # 4.5 è§£å†³ç«æ€æ¡ä»¶ï¼šæ‹‰å–è¿œç¨‹æœ€æ–°æ›´æ”¹å¹¶ Rebase
      - name: Git Pull Before Commit
        run: |
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          # åˆ‡æ¢åˆ° main åˆ†æ”¯å¹¶æ‹‰å–è¿œç¨‹æ›´æ”¹ï¼Œä½¿ç”¨ rebase ä¿æŒçº¿æ€§å†å²
          git pull origin main --rebase
        # æ³¨æ„: è¿™é‡Œçš„ working-directory åº”è¯¥ä¿æŒä¸ job çš„ defaults ä¸€è‡´ï¼Œ
        # é™¤éä½ çš„ä¿®æ”¹æ˜¯åœ¨å…¶ä»–å­ç›®å½•ä¸­è¿›è¡Œçš„ã€‚

      # 5. è‡ªåŠ¨æäº¤ä¿®æ”¹
      - name: Auto Commit Changes
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          # ğŸš¨ ç§»é™¤ repository: . è¿™ä¸€è¡Œ (è®©å®ƒä½¿ç”¨é»˜è®¤çš„å½“å‰ç›®å½•)
          commit_message: "CI: Auto update image tag to ${{ github.sha }}"
          file_pattern: "backend/helm/values.yaml backend/chart-packages/*" # æ˜ç¡®æŒ‡å®šæ–‡ä»¶ï¼Œæ›´å®‰å…¨
          # ğŸš¨ å¿…é¡»ä½¿ç”¨ PAT Token æˆæƒï¼Œå¦åˆ™ BOT æƒé™å¯èƒ½ä¸è¶³ä»¥è¿›è¡Œ Rebase å’Œ Push
          # token: ${{ secrets.YOUR_PAT_TOKEN }} # (å¦‚æœä½ åœ¨ actions/checkout æ²¡æœ‰ä½¿ç”¨ PAT, è¿™é‡Œéœ€è¦)
          # ç¡®ä¿åœ¨ actions/checkout æ­¥éª¤ä¸­ä½¿ç”¨äº† PAT æˆ– GITHUB_TOKEN çš„å†™å…¥æƒé™ã€‚

      # 6. æ¨é€æ›´æ–°åçš„ values.yaml åˆ° Git ä»“åº“
      - name: Commit and Push changes to Chart
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: "CI: Auto update image tag to ${{ github.sha }}"

      - name: Checkout Manifest Repository
        uses: actions/checkout@v5
        with:
          # æ›¿æ¢ä¸ºä½ çš„æ¸…å•ä»“åº“
          repository: sunmery/Manifest
          path: connect-example/backend
          token: ${{ secrets.PAT_TOKEN }} # éœ€è¦ä¸€ä¸ªæ‹¥æœ‰å†™å…¥æƒé™çš„ PAT

      - name: Update ArgoCD Application Version
        run: |
          # å‡è®¾ä½ çš„ Chart ç‰ˆæœ¬ä¹Ÿä½¿ç”¨äº† $VERSION ç¯å¢ƒå˜é‡ (v1.0.0)
          # æˆ–è€…ä½¿ç”¨ ${{ env.VERSION }}
          NEW_CHART_VERSION=${{ env.VERSION }} 
          
          # ä½¿ç”¨ yq æ›´æ–° manifest ä»“åº“ä¸­çš„ Application æ–‡ä»¶
          yq e ".spec.source.targetRevision = \"$NEW_CHART_VERSION\"" \
            -i argo.yaml

      - name: Commit and Push Manifest Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          repository: manifests
          commit_message: "GitOps: Bump backend Chart version to $VERSION"
          #token: ${{ secrets.PAT_TOKEN }}
