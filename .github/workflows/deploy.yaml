name: Test Microservices

on:
  push:
#    branches:
#      - main
    tags:
      - 'v*.*.*'
env:
  #  容器注册表
  REGISTRY: ccr.ccs.tencentyun.com
  HELM_REGISTRY: registry-1.docker.io
  HELM_REGISTRY_USER: lookeke
  # 用户或组织的注册表名
  REGISTER_USER: sumery
  NAMESPACE: connect-example
  # 版本号, git tag的标签名
  # https://docs.github.com/zh/actions/writing-workflows/choosing-what-your-workflow-does/accessing-contextual-information-about-workflow-runs#github-context
  VERSION: ${{ github.ref_name }}
#  VERSION: v1.0.5
  # 目标的操作系统
  GOOS: linux
  # 目标的架构
  GOARCH: arm64
  # golang的镜像
  GO_IMAGE: golang:1.25.1-alpine3.22
  # 代理
  GO_PROXY: https://proxy.golang.org
  # golang环境变量
  CGO_ENABLED: 0

jobs:
  backend-test:
    runs-on: ubuntu-24.04-arm
    #    strategy:
    #      matrix:
    #        #        service: [address, cart, checkout, credit_card, order, payment, product, user]  # 并行执行多个服务
    #        service: [backend]  # 并行执行多个服务
    defaults:
      run:
        shell: bash
        #working-directory: ${{ matrix.service }}
        working-directory: backend
    #    services:
    #      postgres:
    #        image: postgres:17-alpine
    #        env:
    #          POSTGRES_USER: postgres
    #          POSTGRES_PASSWORD: postgres
    #          POSTGRES_DB: postgres
    #        options: >-
    #          --health-cmd pg_isready
    #          --health-interval 10s
    #          --health-timeout 5s
    #          --health-retries 5
    #        ports:
    #          - '5432:5432'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.1'
          check-latest: true
          cache-dependency-path: '**/go.sum'

      #      - name: Install migrate
      #        run: |
      #          curl -L https://github.com/golang-migrate/migrate/releases/download/v4.18.1/migrate.linux-amd64.tar.gz | tar xvz
      #          sudo mv migrate /usr/bin/
      #          which migrate
      #
      #      - name: Run database migration
      #        run: |
      #          export DB_SOURCE="postgresql://postgres:postgres@localhost:5432/postgres?sslmode=disable"
      #          if [ -d ${{ matrix.service }} ]; then
      #            echo "Running migrations..."
      #            make migrate-up
      #          else
      #            echo "Skipping migrations."
      #          fi

      - name: Run Go tests
        run: |
          go test -short -coverprofile=coverage.out ./...
          go tool cover -html=coverage.out -o coverage.html

  backend-build:
    if: github.ref != 'refs/heads/pre'
    needs: backend-test
    permissions:
      contents: write
      pull-requests: write
    runs-on: ubuntu-24.04-arm
    strategy:
      matrix:
        service_config:
          - { service: connect-example-backend }
    defaults:
      run:
        shell: bash
        working-directory: backend
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          # 检出默认分支，以便您可以提交更改
          ref: ${{ github.event.repository.default_branch }}

      # ... (Set up QEMU, Cache, Login, Build/Push Docker Image 步骤保持不变) ...

      # 4. 更新 Helm Chart 的 Image Tag
      - name: Update Helm Chart values.yaml
        run: |
          # 仅运行一次
          yq e '.backend.image.tag = "${{ github.sha }}"' -i helm/values.yaml

      # 5. 打包并推送 Helm Chart 到 OCI
      - name: Bump Chart Version and Package
        run: |
          helm dependency update helm/charts/backend/
          helm package helm/charts/backend/ -d chart-packages/
          echo "${{ secrets.HELM_REGISTRY_PASS }}" | helm registry login registry-1.docker.io -u ${{ env.HELM_REGISTRY_USER }} --password-stdin
          helm push chart-packages/* oci://registry-1.docker.io/${{ env.HELM_REGISTRY_USER }}

      # 5. 暂存所有更改 (Staging Changes)
      - name: Stage all changes
        run: |
          # 明确将 yq 修改的文件和新打包的 chart 暂存
          git add helm/values.yaml chart-packages/*

      # 6. 拉取远程最新更改并 Rebase
      - name: Git Pull Before Commit
        run: |
          # 配置用户身份，为 Rebase 冲突准备
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          
          # 执行 Rebase。因为更改已暂存，Git 会尝试在 Rebase 后重新应用这些暂存的更改。
          git pull origin main --rebase

      # 7. 自动提交修改
      - name: Auto Commit Changes
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          # 因为文件已经被手动 add/暂存，这里只需要提交。
          # file_pattern: '.' 是安全的，因为它只提交已暂存的文件。
          commit_message: "CI: Auto update image tag to ${{ github.sha }} [skip ci]"
          # ⚠️ 注意：不要在这里设置 repository: . 或任何 path 选项，除非你检出了两个不同的仓库。
